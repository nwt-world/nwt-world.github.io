---
import HeaderPages from './HeaderPages.astro';
import LanguageBasedContent from "./LanguageBasedContent.svelte";
import { Image } from 'astro:assets';
import SocialLinks from './SocialLinks.astro';

import nwtLogo from '../assets/nwt.png';
import HeaderLink from './HeaderLink.astro';

---

<script>
// Load initial value
const saved = localStorage.getItem('lang') || 'en';
document.getElementById('lang-select').value = saved;

function syncLangFromPath() {
  const path = window.location.pathname;

  // Supported language suffixes
  const supportedLangs = ['ru', 'es'];
  const defaultLang = 'en';

  // Get last path segment
  const segments = path.split('/').filter(Boolean);
  if (segments.length === 0) return;

  const lastSegment = segments[segments.length - 1];

  // Match suffix "_xx"
  const match = lastSegment.match(/_([a-z]{2})$/);
  if (!match) return;

  const lang = match[1];

  if (!supportedLangs.includes(lang)) return;

  localStorage.setItem('lang', lang);
  document.documentElement.lang = lang;
  document.getElementById('lang-select').value = lang;
}
syncLangFromPath();


// Save on change
document.getElementById('lang-select').addEventListener('change', (e) => {
	localStorage.setItem('lang', e.target.value);
	document.documentElement.lang = e.target.value;

	const newLang = e.target.value;
	const supportedLangs = ['en', 'ru', 'es'];
	const mainPages = ['itinerary', 'country'];
	const defaultLang = 'en';
	const path = window.location.pathname;
	const hasTrailingSlash = path.length > 1 && path.endsWith('/');

	// Split into segments, ignoring empty due to leading/trailing slashes
	const segments = path.split('/').filter(Boolean);

	// Root "/" => just go to "/"
	if (segments.length === 0) {
		window.location.href = '/';
		return;
	}

	// Work on the last segment only (the "slug")
	let last = segments[segments.length - 1];

	// Check for main pages
	for (const page of mainPages) {
		if (last === page) {
			window.location.href = '/' + page;
			return;
		}
	}

	// Remove existing "_xx" suffix if it matches one of supported langs
	for (const lang of supportedLangs) {
		const suffix = `_${lang}`;
		if (last.endsWith(suffix)) {
			last = last.slice(0, -suffix.length);
			break;
		}
	}

	// Add new suffix unless it's the default language
	if (newLang !== defaultLang) {
		last = `${last}_${newLang}`;
	}

	// Put it back
	segments[segments.length - 1] = last;

	// Rebuild URL
	const newPath = '/' + segments.join('/') + (hasTrailingSlash ? '/' : '');
	window.location.href = newPath;
});

const toggle = document.querySelector('.menu-toggle');
const menu = document.querySelector('.mobile-menu');

toggle?.addEventListener('click', () => {
	if (!menu) return;

	const isHidden = getComputedStyle(menu).display === 'none';

	menu.style.display = isHidden ? 'flex' : 'none';
	toggle.setAttribute('aria-expanded', String(isHidden));
});
</script>

<header>
	<nav>
		<!-- MOBILE MENU BUTTON -->
		<button class="menu-toggle" aria-label="Menu" aria-expanded="false">
			☰
		</button>
		<!-- MOBILE MENU PANEL -->
		<div class="mobile-menu">
			<HeaderPages />
		</div>
		<h2><a href="/"><Image class="main_logo" width={512} src={nwtLogo} alt="NWT" loading="eager" /></a></h2>
		<div class="internal-links">
			<HeaderPages />
		</div>
		<select id="lang-select" class="lang-select">
			<option value="en">English</option>
			<option value="es">Español</option>
			<option value="ru">Русский</option>
		</select>
		<SocialLinks hideOnMobile />

	</nav>
</header>
<style>
	header {
		margin: 0;
		padding: 0 1em;
		background: #bdcae7;
		box-shadow: 0 2px 8px rgba(var(--black), 5%);
	}
	h2 {
		margin: 0;
		font-size: 1em;
	}

	h2 a,
	h2 a.active {
		text-decoration: none;
	}
	nav {
		display: flex;
		align-items: center;
		justify-content: space-between;
	}
	nav a {
		padding: 0.5em 0.5em;
		color: var(--black);
		border-bottom: 4px solid transparent;
		text-decoration: none;
	}
	nav a.active {
		text-decoration: none;
		border-bottom-color: var(--accent);
	}

	.nice-select {
		appearance: none;
		background-color: #bdcae7;
		border: 1px solid #aa9ec8;
		padding: 6px 32px 6px 12px;
		border-radius: 6px;
		font-size: 14px;
		cursor: pointer;
		background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='16' width='16' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'><polygon points='0,0 20,0 10,12'/></svg>");
		background-repeat: no-repeat;
		background-position: right 8px center;
		background-size: 12px;
	}

	.nice-select:focus {
		outline: none;
		border-color: #4f46e5;
		box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
	}

	.lang-select {
		appearance: none;
		background-color: #bdcae7;
		border: 1px solid #ffffff;
		padding: 6px 36px 6px 12px;
		border-radius: 8px;
		font-size: 14px;
		color: #2b2b2b;
		cursor: pointer;

		background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 20 20'><path d='M5 7l5 6 5-6z' fill='%23666'/></svg>");
		background-repeat: no-repeat;
		background-position: right 10px center;
		background-size: 12px;
	}

	.lang-select:hover {
		background-color: #b4c3e3;
	}

	.lang-select:focus {
		outline: none;
		border-color: #4f46e5;
		box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
	}
	.menu-toggle {
		display: none;
		background: none;
		border: none;
		font-size: 1.4rem;
		cursor: pointer;
	}

	.mobile-menu {
		background: #bdcae7;
		border-top: 1px solid #e0e4f2;
		display: none;
		flex-direction: column;
		padding: 0.5rem 1rem;
	}

	.mobile-menu a {
		padding: 0.6rem 0;
		text-decoration: none;
		color: #000;
		font-size: 1rem;
	}

	.mobile-menu a + a {
		border-top: 1px solid rgba(0, 0, 0, 0.1);
	}


    @media (max-width: 1200px) {
		.main_logo {
			display: none;
		}
	}
    @media (max-width: 500px) {
		.menu-toggle {
			display: flex;
		}
		.internal-links{
			display: none;
		}
		header {
			padding: 10px 1em;
		}
	}

</style>
