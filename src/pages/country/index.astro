---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import Header from "../../components/Header.astro";
import LanguageBasedContent from "../../components/LanguageBasedContent.svelte";
import CountryFilter from "../../components/CountryFilter.svelte";
import CountryList from "../../components/CountryList.astro";
import { getLangFromId } from "../../lib/lang";
import { SITE_TITLE } from "../../consts";

import placeholder_en from "../../assets/placeholder/country_en.png";
import placeholder_es from "../../assets/placeholder/country_es.png";
import placeholder_ru from "../../assets/placeholder/country_ru.png";

const entries = await getCollection("country");

function postsByLang(lang: string) {
  return entries.filter((e) => getLangFromId(e.id) === lang && !e.data.hide);
}

function localeForLang(lang: string) {
  // keep simple; adjust if you use 'es-AR' etc.
  if (lang === "es") return "es";
  if (lang === "ru") return "ru";
  return "en";
}

function sortedPostsByLang(lang: string) {
  const filtered = postsByLang(lang);
  const locale = localeForLang(lang);

  const byTitleAZ = (a, b) =>
    (a.data.title ?? "").localeCompare(b.data.title ?? "", locale, {
      sensitivity: "base",
    });

  const pinned = filtered.filter((e) => e.data.pinned === true).sort(byTitleAZ);

  const visited = filtered
    .filter((e) => e.data.pinned !== true)
    .filter((e) => e.data.planned !== true)
    .sort(byTitleAZ);

  const planned = filtered
    .filter((e) => e.data.pinned !== true)
    .filter((e) => e.data.planned === true)
    .sort(byTitleAZ);

  return { pinned, visited, planned };
}

function badgesForPosts(posts) {
  const counts = new Map<string, number>();

  for (const p of posts) {
    const badges = (p.data?.badges ?? p.data?.badge ?? []) as string[];
    for (const b of badges) counts.set(b, (counts.get(b) ?? 0) + 1);

    const region = p.data?.region as string | undefined;
    if (region) counts.set(region, (counts.get(region) ?? 0) + 1);
  }

  return Array.from(counts.entries())
    .sort((a, b) => {
      const diff = b[1] - a[1];
      return diff !== 0 ? diff : a[0].localeCompare(b[0]);
    })
    .map(([tag]) => tag);
}

function placeholderByLang(lang: string) {
  if (lang === "es") return placeholder_es;
  if (lang === "ru") return placeholder_ru;
  return placeholder_en;
}

// Flat lists for filters
const posts_en = postsByLang("en");
const posts_es = postsByLang("es");
const posts_ru = postsByLang("ru");

// Grouped lists for display
const grouped_en = sortedPostsByLang("en");
const grouped_es = sortedPostsByLang("es");
const grouped_ru = sortedPostsByLang("ru");

// Filter options
const badges_en = badgesForPosts(posts_en);
const badges_es = badgesForPosts(posts_es);
const badges_ru = badgesForPosts(posts_ru);

const META = {
  en: {
    title: `Countries — ${SITE_TITLE}`,
    description:
      "Countries picked for tranquil, safe, nature-rich travel. Explore highlights, best seasons, and filter by themes like mountains, islands, snorkeling, hiking.",
  },
  es: {
    title: `Países — ${SITE_TITLE}`,
    description:
      "Países elegidos para viajar con calma, seguridad y naturaleza. Explorá destacados, mejor temporada y filtrá por temas: montañas, islas, snorkel, trekking.",
  },
  ru: {
    title: `Страны  — ${SITE_TITLE}`,
    description:
      "Описание и оценка стран для спокойного отдыха, ключевые места и фильтры по темам: горы, острова, снорклинг, хайкинг.",
  },
} as const;

---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={META.en.title} description={META.en.description}/>
    <style>
      main {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <section>
        <LanguageBasedContent client:load lang="en" meta={META}>
			<div slot="en">
			<CountryFilter client:load lang="en" posts={posts_en} allBadges={badges_en} gridId="country-grid-en" />
			<CountryList
				gridId="country-grid-en"
				pinned={grouped_en.pinned}
				visited={grouped_en.visited}
				planned={grouped_en.planned}
				placeholder={placeholder_en}
			/>
			</div>

			<div slot="es">
			<CountryFilter client:load lang="es" posts={posts_es} allBadges={badges_es} gridId="country-grid-es" />
			<CountryList
				gridId="country-grid-es"
				pinned={grouped_es.pinned}
				visited={grouped_es.visited}
				planned={grouped_es.planned}
				placeholder={placeholder_es}
			/>
			</div>

			<div slot="ru">
			<CountryFilter client:load lang="ru" posts={posts_ru} allBadges={badges_ru} gridId="country-grid-ru" />
			<CountryList
				gridId="country-grid-ru"
				pinned={grouped_ru.pinned}
				visited={grouped_ru.visited}
				planned={grouped_ru.planned}
				placeholder={placeholder_ru}
			/>
			</div>
        </LanguageBasedContent>
      </section>
    </main>
    <Footer />
  </body>
</html>